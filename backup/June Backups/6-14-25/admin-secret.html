<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Login - Real InvestCo</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap">
    <link rel="stylesheet" href="styles.css">
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <style>
        body { font-family: Arial, sans-serif; background: #f4f6fb; }
        .container { max-width: 700px; margin: 120px auto 0 auto; background: #fff; border-radius: 12px; box-shadow: 0 4px 24px rgba(0,0,0,0.08); padding: 32px; }
        h1 { text-align: center; color: #1A237E; }
        label { font-weight: 600; display: block; margin-top: 16px; margin-bottom: 4px; }
        input { width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #ccc; margin-bottom: 12px; font-size: 1em; }
        button { width: 100%; padding: 10px; background: #1A237E; color: #fff; border: none; border-radius: 8px; font-size: 1.1em; font-weight: 700; cursor: pointer; margin-top: 12px; transition: background 0.2s; }
        button:hover { background: #FFD700; color: #1A237E; }
        .error { color: red; margin-top: 10px; }
        .logout-btn { background: #d32f2f; margin-top: 20px; }
        .private-field { 
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
        }
        .private-field-label {
            color: #666;
            font-size: 0.9em;
            margin-top: 4px;
        }
        #image-urls-container input[type="text"] {
          width: 90%;
          min-width: 200px;
          margin-bottom: 4px;
        }
        #image-urls-container {
          margin-bottom: 8px;
        }
    </style>
</head>
<body>
    <div class="container" id="auth-container">
        <h1>Admin Login</h1>
        <form id="login-form">
            <label for="email">Email:</label>
            <input type="email" id="email" required>
            <label for="password">Password:</label>
            <input type="password" id="password" required>
            <button type="submit">Login</button>
            <div class="error" id="error"></div>
        </form>
    </div>
    <div class="container" id="admin-content" style="display:none;">
        <h1>Admin Panel</h1>
        <p>Welcome, <span id="user-email"></span>!</p>
        <!-- Add/Edit Property Form -->
        <form id="add-property-form" style="margin-bottom: 24px;">
            <div style="margin-bottom:8px;color:#d32f2f;font-size:0.98em;">Fields marked with <span style='color:#d32f2f'>*</span> are required.</div>
            <input type="hidden" id="property-id" name="property-id">
            <div id="property-numeric-id-row" style="display:none;">
              <label for="property-numeric-id">ID:</label>
              <input type="text" id="property-numeric-id" name="property-numeric-id" readonly style="background:#f8f9fa; color:#888;">
            </div>
            <label for="property-title">Title <span style='color:#d32f2f'>*</span>:</label>
            <textarea id="property-title" name="property-title" rows="2" required></textarea>
            <label for="property-price">Price <span style='color:#d32f2f'>*</span>:</label>
            <input type="text" id="property-price" name="property-price" required>
            <label for="property-description">Description:</label>
            <textarea id="property-description" name="property-description" rows="2"></textarea>
            <label for="property-location">Location:</label>
            <input type="text" id="property-location" name="property-location">
            <label for="property-private-address">Private Address (Internal Use Only):</label>
            <input type="text" id="property-private-address" name="property-private-address" 
                   placeholder="Full street address" class="private-field"
                   pattern="^[0-9]+\s+[A-Za-z0-9\s,\.\-]+$"
                   title="Please enter a valid street address (e.g., 123 Main St)">
            <div class="private-field-label">This address will not be displayed on the public website.</div>
            <label for="property-bedrooms">Bedrooms:</label>
            <input type="number" id="property-bedrooms" name="property-bedrooms">
            <label for="property-bathrooms">Bathrooms:</label>
            <input type="number" id="property-bathrooms" name="property-bathrooms">
            <label for="property-area">Area (sq ft):</label>
            <input type="text" id="property-area" name="property-area">
            <label for="property-arv">ARV:</label>
            <input type="text" id="property-arv" name="property-arv">
            <label for="property-zipcode">Zip Code:</label>
            <input type="text" id="property-zipcode" name="property-zipcode">
            <label for="property-city">City:</label>
            <input type="text" id="property-city" name="property-city">
            <label for="property-state">State:</label>
            <input type="text" id="property-state" name="property-state">
            <label for="property-county">County:</label>
            <input type="text" id="property-county" name="property-county">
            <label for="property-lotsize">Lot Size:</label>
            <input type="text" id="property-lotsize" name="property-lotsize">
            <label for="property-order">Order:</label>
            <input type="number" id="property-order" name="property-order" min="1" placeholder="1 = top left, 2 = next, etc.">
            <label>Image URLs:</label>
            <div id="image-urls-container"></div>
            <button type="button" id="add-image-url">Add Image URL</button>
            <br>
            <button type="submit">Save Property</button>
            <button type="button" id="cancel-edit" style="display:none; margin-left:10px;">Cancel</button>
        </form>
        <!-- Properties Table -->
        <table id="properties-table" border="1" style="margin-top:20px; width:100%;">
            <thead>
                <tr>
                    <th>Title</th>
                    <th>ID</th>
                    <th>Price</th>
                    <th>Private Address</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <!-- Properties will be listed here -->
            </tbody>
        </table>
        <button class="logout-btn" onclick="logout()">Logout</button>
    </div>
    
    <!-- Remove React and Babel scripts -->
    <!-- <script src="https://unpkg.com/react@17/umd/react.development.js"></script> -->
    <!-- <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script> -->
    <!-- <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script> -->

    <!-- Remove React Application script tag, use only plain <script> -->
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDXifeppD7kBgpgwu74Aa-5h6t_4ieFwq0",
            authDomain: "realinvestco-web.firebaseapp.com",
            projectId: "realinvestco-web",
            storageBucket: "realinvestco-web.firebasestorage.app",
            messagingSenderId: "1021426656860",
            appId: "1:1021426656860:web:1a1f9cb16b3f0a2158a899",
            measurementId: "G-X30NR9MZGP"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // Show admin content if logged in
        auth.onAuthStateChanged(user => {
            if (user) {
                document.getElementById('auth-container').style.display = 'none';
                document.getElementById('admin-content').style.display = 'block';
                document.getElementById('user-email').textContent = user.email;
                loadProperties();
            } else {
                document.getElementById('auth-container').style.display = 'block';
                document.getElementById('admin-content').style.display = 'none';
            }
        });

        // Login form handler
        document.getElementById('login-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            auth.signInWithEmailAndPassword(email, password)
                .catch(error => {
                    document.getElementById('error').textContent = error.message;
                });
        });

        // Logout function
        function logout() {
            auth.signOut();
        }

        let editingId = null;
        let imageUrls = [];

        // Helper to render image URL inputs
        function renderImageInputs() {
            const container = document.getElementById('image-urls-container');
            container.innerHTML = '';
            imageUrls.forEach((url, idx) => {
                const div = document.createElement('div');
                div.style.display = 'flex';
                div.style.alignItems = 'center';
                div.style.marginBottom = '4px';
                div.innerHTML = `<input type="text" value="${url}" data-idx="${idx}" style="flex:1; min-width:200px; margin-bottom:4px;" placeholder="https://example.com/image.jpg">
                    <button type="button" data-remove="${idx}" style="margin-left:6px;">Remove</button>`;
                container.appendChild(div);
            });
            // Add event listeners for remove buttons
            container.querySelectorAll('button[data-remove]').forEach(btn => {
                btn.onclick = function() {
                    const idx = Number(this.getAttribute('data-remove'));
                    imageUrls.splice(idx, 1);
                    renderImageInputs();
                };
            });
            // Add event listeners for input changes
            container.querySelectorAll('input[type="text"]').forEach(input => {
                input.oninput = function() {
                    const idx = Number(this.getAttribute('data-idx'));
                    imageUrls[idx] = this.value;
                };
            });
        }

        document.getElementById('add-image-url').onclick = function() {
            imageUrls.push('');
            renderImageInputs();
        };

        // Fetch and display properties
        async function loadProperties() {
            const table = document.getElementById('properties-table').querySelector('tbody');
            table.innerHTML = '';
            const snapshot = await db.collection('properties').get();
            const loadedProperties = [];
            snapshot.forEach(doc => {
                const property = doc.data();
                loadedProperties.push(property);
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${property.title ? property.title : '(No Title)'}</td>
                    <td>${property.id ? property.id : ''}</td>
                    <td style='white-space:nowrap;'>${property.price ? property.price : '(No Price)'}</td>
                    <td>${property.privateAddress ? property.privateAddress : '(No Address)'}</td>
                    <td>
                        <a href="property.html?id=${doc.id}" target="_blank">View</a>
                        <button onclick="editProperty('${doc.id}')">Edit</button>
                        <button onclick="deleteProperty('${doc.id}')">Delete</button>
                    </td>
                `;
                table.appendChild(row);
            });
            console.log('Loaded properties from Firestore:', loadedProperties);
        }

        // Helper to get the next sequential property id
        async function getNextPropertyId() {
            const snapshot = await db.collection('properties').get();
            let maxId = 1024;
            snapshot.forEach(doc => {
                const property = doc.data();
                if (property.id) {
                    const num = parseInt(property.id);
                    if (!isNaN(num) && num > maxId) {
                        maxId = num;
                    }
                }
            });
            return maxId + 1;
        }

        // Form submission handler
        document.getElementById('add-property-form').addEventListener('submit', async function(e) {
            e.preventDefault();

            // Validate private address format
            const privateAddress = document.getElementById('property-private-address').value;
            if (privateAddress && !/^[0-9]+\s+[A-Za-z0-9\s,\.\-]+$/.test(privateAddress)) {
                alert('Please enter a valid street address (e.g., 123 Main St)');
                return;
            }

            const propertyData = {
                title: document.getElementById('property-title').value,
                price: document.getElementById('property-price').value,
                description: document.getElementById('property-description').value,
                location: document.getElementById('property-location').value,
                privateAddress: document.getElementById('property-private-address').value,
                bedrooms: document.getElementById('property-bedrooms').value,
                bathrooms: document.getElementById('property-bathrooms').value,
                area: document.getElementById('property-area').value,
                arv: document.getElementById('property-arv').value,
                zipCode: document.getElementById('property-zipcode').value,
                city: document.getElementById('property-city').value,
                state: document.getElementById('property-state').value,
                county: document.getElementById('property-county').value,
                lotSize: document.getElementById('property-lotsize').value,
                images: imageUrls.filter(url => url.trim() !== ''),
                order: document.getElementById('property-order').value ? Number(document.getElementById('property-order').value) : undefined
            };
            // Validation: require title and price
            if (!propertyData.title || !propertyData.price) {
                alert('Title and Price are required fields.');
                return;
            }
            // Set propertyData.id robustly
            console.log('EditingId:', editingId, 'Numeric ID field:', document.getElementById('property-numeric-id').value);
            if (editingId) {
                // Always use the original ID from the hidden field
                propertyData.id = Number(document.getElementById('property-numeric-id').value);
            } else {
                // Only generate a new ID for new properties
                propertyData.id = await getNextPropertyId();
            }
            console.log('Property to save:', propertyData);
            // Remove undefined fields before saving to Firestore
            Object.keys(propertyData).forEach(key => propertyData[key] === undefined && delete propertyData[key]);
            if (editingId) {
                await db.collection('properties').doc(editingId).update(propertyData);
            } else {
                // Add property and then update with _docId and id
                const docRef = await db.collection('properties').add({
                    ...propertyData,
                    _docId: null,
                    id: propertyData.id
                });
                await docRef.update({ _docId: docRef.id });
                console.log('Saved new property with docRef.id:', docRef.id);
            }
            editingId = null;
            this.reset();
            imageUrls = [];
            renderImageInputs();
            document.getElementById('cancel-edit').style.display = 'none';
            document.getElementById('property-order').value = '';
            loadProperties();
        });

        // Edit property
        window.editProperty = async function(id) {
            editingId = id;
            const doc = await db.collection('properties').doc(id).get();
            const property = doc.data();
            document.getElementById('property-id').value = id;
            document.getElementById('property-title').value = property.title || '';
            document.getElementById('property-price').value = property.price || '';
            document.getElementById('property-description').value = property.description || '';
            document.getElementById('property-location').value = property.location || '';
            document.getElementById('property-private-address').value = property.privateAddress || '';
            document.getElementById('property-bedrooms').value = property.bedrooms || '';
            document.getElementById('property-bathrooms').value = property.bathrooms || '';
            document.getElementById('property-area').value = property.area || '';
            document.getElementById('property-arv').value = property.arv || '';
            document.getElementById('property-zipcode').value = property.zipCode || '';
            document.getElementById('property-city').value = property.city || '';
            document.getElementById('property-state').value = property.state || '';
            document.getElementById('property-county').value = property.county || '';
            document.getElementById('property-lotsize').value = property.lotSize || '';
            document.getElementById('property-order').value = property.order !== undefined ? property.order : '';
            imageUrls = Array.isArray(property.images) ? property.images.slice() : [];
            renderImageInputs();
            document.getElementById('cancel-edit').style.display = 'inline-block';
            document.getElementById('property-numeric-id-row').style.display = 'block';
            document.getElementById('property-numeric-id').value = property.id || '';
        };

        // Cancel edit
        document.getElementById('cancel-edit').addEventListener('click', function() {
            editingId = null;
            document.getElementById('add-property-form').reset();
            imageUrls = [];
            renderImageInputs();
            this.style.display = 'none';
            document.getElementById('property-numeric-id-row').style.display = 'none';
            document.getElementById('property-numeric-id').value = '';
        });

        // Delete property
        window.deleteProperty = async function(id) {
            if (confirm('Are you sure you want to delete this property?')) {
                await db.collection('properties').doc(id).delete();
                loadProperties();
            }
        };

        document.getElementById('property-zipcode').addEventListener('blur', async function(e) {
            const zip = e.target.value.trim();
            if (zip && zip.length === 5 && /^\d{5}$/.test(zip)) {
                try {
                    // Fetch city and state from Zippopotam.us
                    const response = await fetch(`https://api.zippopotam.us/us/${zip}`);
                    if (!response.ok) return;
                    const data = await response.json();
                    if (!data.places || !data.places[0]) return;
                    const place = data.places[0];
                    document.getElementById('property-city').value = place['place name'] || '';
                    document.getElementById('property-state').value = place['state abbreviation'] || '';
                    // Fetch county from FCC API using lat/lon
                    const lat = Number(place.latitude);
                    const lon = Number(place.longitude);
                    if (!isNaN(lat) && !isNaN(lon)) {
                        const fccUrl = `https://geo.fcc.gov/api/census/block/find?format=json&latitude=${lat}&longitude=${lon}`;
                        const countyRes = await fetch(fccUrl);
                        if (countyRes.ok) {
                            const countyData = await countyRes.json();
                            if (countyData.County && countyData.County.name) {
                                document.getElementById('property-county').value = countyData.County.name.replace(/\s*County\s*County$/i, ' County');
                            }
                        }
                    }
                } catch (err) { /* ignore errors */ }
            }
        });
    </script>

    <style>
        .admin-actions {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .view-public-link {
            padding: 10px 20px;
            background: #1A237E;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 500;
            transition: background 0.2s, color 0.2s;
        }

        .view-public-link:hover {
            background: #FFD700;
            color: #1A237E;
        }

        .county {
            color: #666;
            font-size: 0.9em;
            margin: -8px 0 8px 0;
        }

        .side-by-side-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 32px;
            align-items: flex-start;
        }
        .property-card.editing {
            border: 2px solid #FFD700;
        }
        .side-form {
            min-width: 350px;
            max-width: 400px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-left: 16px;
            padding: 24px 16px;
        }
        .property-id {
            font-size: 0.9em;
            color: #888;
            margin-top: 8px;
        }
    </style>

    <script>
      // Example: Add property to table
      document.getElementById('add-property-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const title = document.getElementById('property-title').value;
        const price = document.getElementById('property-price').value;
        const table = document.getElementById('properties-table').querySelector('tbody');
        const row = document.createElement('tr');
        row.innerHTML = `<td>${title}</td><td>${price}</td>`;
        table.appendChild(row);
        this.reset();
      });
    </script>
</body>
</html>