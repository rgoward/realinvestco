<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Contacts - Real InvestCo Admin - CACHE BUST 2025-01-27</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .section { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
        button { padding: 10px 20px; background: #007cba; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #005a87; }
        .success { color: #28a745; background: #d4edda; padding: 10px; border-radius: 4px; margin: 10px 0; }
        .error { color: #dc3545; background: #f8d7da; padding: 10px; border-radius: 4px; margin: 10px 0; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 768px) { .grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
            <h1>üìã Manage Contacts</h1>
            <p>Real InvestCo Admin Panel</p>
                </div>
                <a href="admin-secret.html" style="background: #28a745; color: white; padding: 10px 20px; text-decoration: none; border-radius: 4px;">‚Üê Back to Admin</a>
            </div>
        </div>

        <!-- Email Templates Section -->
        <div class="section">
            <h3>üìß Email Templates</h3>
            <div class="grid">
                <div class="form-group">
                    <label for="outboundTemplate">Outbound Contact Template</label>
                    <textarea id="outboundTemplate" rows="6" placeholder="Enter your outbound contact email template...">Hello {FIRSTNAME},

Thank you for connecting with us at Real InvestCo. I wanted to follow up on our recent conversation about real estate investment opportunities.

As we discussed, we specialize in helping investors find the right properties for their goals, whether that's wholesale deals, fix-and-flip opportunities, or long-term investments.

I'd love to schedule a brief call to discuss your specific investment criteria and show you some current opportunities that might be a good fit.

You can reach me directly at [YOUR_PHONE] or reply to this email to set up a time that works for you.

Best regards,
[YOUR_NAME]
Real InvestCo</textarea>
                </div>
                <div class="form-group">
                    <label for="inboundTemplate">Inbound Lead Response Template</label>
                    <textarea id="inboundTemplate" rows="6" placeholder="Enter your inbound lead response email template...">Thank you for reaching out to Real InvestCo! We've received your inquiry and I'm excited to help you with your real estate investment goals.

I'll be reviewing your message and getting back to you within 24 hours with next steps.

In the meantime, feel free to browse our current investment opportunities on our website.

Best regards,
[YOUR_NAME]
Real InvestCo</textarea>
                </div>
            </div>
            <button onclick="saveEmailTemplates()">üíæ Save Templates</button>
        </div>

        <!-- Add Contact Section -->
        <div class="section">
            <h3>‚ûï Add New Outbound Contact</h3>
            <form id="contactForm">
                <div class="grid">
                    <div class="form-group">
                        <label for="fullName">Full Name *</label>
                        <input type="text" id="fullName" name="fullName" required>
                    </div>
                    <div class="form-group">
                        <label for="email">Email Address *</label>
                        <input type="email" id="email" name="email" required>
                    </div>
                    <div class="form-group">
                        <label for="cellPhone">Cell Phone *</label>
                        <input type="tel" id="cellPhone" name="cellPhone" required>
                    </div>
                    <div class="form-group">
                        <label for="contactSource">Contact Source *</label>
                        <select id="contactSource" name="contactSource" required onchange="handleNewContactSourceChange()">
                            <option value="">Select source...</option>
                            <option value="RIC CA Activity" selected>RIC CA Activity</option>
                            <option value="Facebook">Facebook</option>
                            <option value="Linked In">Linked In</option>
                            <option value="Referral">Referral</option>
                            <option value="Custom">Custom</option>
                        </select>
                        <input type="text" id="customContactSource" name="customContactSource" placeholder="Enter custom source..." style="display: none; margin-top: 5px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; width: 100%;">
                    </div>
                </div>
                
                <!-- Address Fields for Direct Mail -->
                <div class="form-group">
                    <h4 style="margin-bottom: 10px; color: #007cba;">üì¨ Mailing Address (Optional - for direct mail campaigns)</h4>
                </div>
                <div class="grid">
                    <div class="form-group">
                        <label for="addressLine1">Street Address</label>
                        <input type="text" id="addressLine1" name="addressLine1" placeholder="123 Main Street">
                    </div>
                    <div class="form-group">
                        <label for="addressLine2">Apt/Suite/Unit (Optional)</label>
                        <input type="text" id="addressLine2" name="addressLine2" placeholder="Apt 4B">
                    </div>
                    <div class="form-group">
                        <label for="addressCity">City</label>
                        <input type="text" id="addressCity" name="addressCity" placeholder="Phoenix">
                    </div>
                    <div class="form-group">
                        <label for="addressState">State</label>
                        <input type="text" id="addressState" name="addressState" placeholder="AZ">
                    </div>
                    <div class="form-group">
                        <label for="addressZip">ZIP Code</label>
                        <input type="text" id="addressZip" name="addressZip" placeholder="85001">
                    </div>
                    <div class="form-group">
                        <label for="addressCountry">Country</label>
                        <input type="text" id="addressCountry" name="addressCountry" value="US" placeholder="US">
                    </div>
                </div>
                <div class="form-group">
                    <label for="notes">Initial Notes</label>
                    <textarea id="notes" name="notes" rows="4" placeholder="Enter any initial notes about this contact..."></textarea>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" name="newsletter"> Subscribe to Newsletter
                    </label>
                </div>
                <button type="submit">‚ûï Add Contact</button>
                <button type="button" onclick="clearForm()">üóëÔ∏è Clear</button>
            </form>
        </div>

        <!-- Contacts List -->
        <div class="section">
            <h3>üë• All Contacts</h3>
            <div class="form-group">
                <input type="text" id="searchInput" placeholder="üîç Search by name, email, phone, or source...">
            </div>
            <div class="form-group">
                <button onclick="deleteAllContacts()" class="btn btn-danger" style="background: #dc3545;">
                    üóëÔ∏è Delete All Contacts
                </button>
                <button onclick="exportContacts()" class="btn btn-secondary" style="background: #6c757d;">
                    üìä Export Contacts
                </button>
                <button onclick="clearSyncFlags()" class="btn btn-warning" style="background: #ffc107; color: #000;">
                    üîÑ Clear Sync Flags
                </button>
                <button onclick="fixPostGridId()" class="btn btn-info" style="background: #17a2b8;">
                    üîß Fix PostGrid ID
                </button>
            </div>
            <div id="contactsList">
                <p>Loading contacts...</p>
            </div>
        </div>
    </div>

    <!-- Send Email Modal -->
    <div id="emailModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeEmailModal()">&times;</span>
            <h2>üìß Send Email</h2>
            <form id="emailForm">
                <div class="form-group">
                    <label for="emailTemplate">Template</label>
                    <select id="emailTemplate" onchange="loadEmailTemplate()">
                        <option value="">Select template...</option>
                        <option value="outbound">Outbound Contact</option>
                        <option value="inbound">Inbound Response</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="emailSubject">Subject *</label>
                    <input type="text" id="emailSubject" required>
                </div>
                <!-- Message field removed - using Brevo template content -->
                <button type="submit">üì§ Send Email</button>
                <button type="button" onclick="closeEmailModal()">‚ùå Cancel</button>
            </form>
        </div>
    </div>

    <!-- Status Messages -->
    <div id="statusContainer"></div>

    <!-- Firebase Configuration - WORKING VERSION -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <script>
        // Firebase initialization

        const firebaseConfig = {
            apiKey: "AIzaSyDXifeppD7kBgpgwu74Aa-5h6t_4ieFwq0",
            authDomain: "realinvestco-web.firebaseapp.com",
            projectId: "realinvestco-web",
            storageBucket: "realinvestco-web.firebasestorage.app",
            messagingSenderId: "1021426656860",
            appId: "1:1021426656860:web:1a1f9cb16b3f0a2158a899",
            measurementId: "G-X30NR9MZGP"
        };

        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();
        
        // Clear Firestore cache
        db.clearPersistence().catch(error => {
            console.log('Cache clear failed (normal if already initialized):', error);
        });
        
        // Firebase initialized

        // Global variables
        let allContacts = [];
        let currentContact = null;
        let isLoadingContacts = false;

        // Load contacts function - now loads from multiple collections
        async function loadContacts() {
            if (isLoadingContacts) {
                console.log('‚ö†Ô∏è Already loading contacts, skipping...');
                return;
            }
            
            isLoadingContacts = true;
            console.log('üîÑ LOAD CONTACTS CALLED - Stack trace:', new Error().stack.split('\n')[1]);
            
            try {
                allContacts = [];
                
                // Load from unified contacts collection only
                const contactsQuery = await db.collection('contacts').get();
                
                contactsQuery.forEach((doc) => {
                    const data = doc.data();
                    allContacts.push({ 
                        id: doc.id, 
                        source: 'contacts', // Always use 'contacts' collection
                        ...data 
                    });
                });
                // console.log(`‚úÖ Loaded ${contactsQuery.size} contacts`);
                
                // Sort by date (newest first)
                allContacts.sort((a, b) => {
                    const dateA = new Date(a.dateAdded || a.timestamp || 0);
                    const dateB = new Date(b.dateAdded || b.timestamp || 0);
                    return dateB - dateA;
                });
                
                displayContacts(allContacts);
                
            } catch (error) {
                console.error('‚ùå Error loading contacts:', error);
                const container = document.getElementById('contactsList');
                if (container) {
                    container.innerHTML = `<p style="color: red;">‚ùå Error: ${error.message}<br/>Check console for details</p>`;
                }
            } finally {
                isLoadingContacts = false;
            }
        }

        // Display contacts function
        function displayContacts(contacts) {
            const container = document.getElementById('contactsList');
            
            if (!container) {
                console.error('‚ùå contactsList container not found');
                return;
            }
            
            if (contacts.length === 0) {
                container.innerHTML = '<p>No contacts found in database.</p>';
                return;
            }
            
            const contactsHtml = contacts.map(contact => {
                const hasAddress = contact.address_line1 && contact.address_city && contact.address_state && contact.address_zip;
                const addressHtml = hasAddress ? 
                    `<p>üì¨ ${contact.address_line1}${contact.address_line2 ? ', ' + contact.address_line2 : ''}, ${contact.address_city}, ${contact.address_state} ${contact.address_zip}</p>` : 
                    '<p style="color: #999;">üì¨ No mailing address</p>';
                
                return `
                <div class="contact-item" style="border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 8px; background: white;">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div>
                            <h4>
                                <a href="contact-detail.html?id=${contact.id}&collection=${contact.source}" 
                                   style="color: #007cba; text-decoration: none; cursor: pointer;"
                                   onmouseover="this.style.textDecoration='underline'"
                                   onmouseout="this.style.textDecoration='none'">
                                    ${contact.name || contact.fullName || 'No Name'} ${hasAddress ? 'üìÆ' : ''}
                                </a>
                            </h4>
                            <p>üìß ${contact.email || 'No Email'}</p>
                            <p>üì± ${contact.cellPhone || contact.phone || 'No Phone'}</p>
                            ${addressHtml}
                            <div style="display: flex; align-items: center; gap: 8px; margin: 5px 0;">
                                <span>üìä Source:</span>
                                <select id="sourceSelect_${contact.id}" onchange="updateContactSource('${contact.id}')" style="padding: 4px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                                    <option value="RIC CA Activity" ${(contact.contactSource || contact.source) === 'RIC CA Activity' ? 'selected' : ''}>RIC CA Activity</option>
                                    <option value="Facebook" ${(contact.contactSource || contact.source) === 'Facebook' ? 'selected' : ''}>Facebook</option>
                                    <option value="Linked In" ${(contact.contactSource || contact.source) === 'Linked In' ? 'selected' : ''}>Linked In</option>
                                    <option value="Referral" ${(contact.contactSource || contact.source) === 'Referral' ? 'selected' : ''}>Referral</option>
                                    <option value="Website" ${(contact.contactSource || contact.source) === 'Website' ? 'selected' : ''}>Website</option>
                                    <option value="Google" ${(contact.contactSource || contact.source) === 'Google' ? 'selected' : ''}>Google</option>
                                    <option value="Direct Mail" ${(contact.contactSource || contact.source) === 'Direct Mail' ? 'selected' : ''}>Direct Mail</option>
                                    <option value="Cold Call" ${(contact.contactSource || contact.source) === 'Cold Call' ? 'selected' : ''}>Cold Call</option>
                                    <option value="Custom" ${!['RIC CA Activity', 'Facebook', 'Linked In', 'Referral', 'Website', 'Google', 'Direct Mail', 'Cold Call'].includes(contact.contactSource || contact.source) ? 'selected' : ''}>Custom</option>
                                </select>
                                ${!['RIC CA Activity', 'Facebook', 'Linked In', 'Referral', 'Website', 'Google', 'Direct Mail', 'Cold Call'].includes(contact.contactSource || contact.source) ? 
                                    `<input type="text" id="customSource_${contact.id}" value="${contact.contactSource || contact.source || ''}" placeholder="Enter custom source..." onblur="saveCustomSource('${contact.id}')" onkeypress="if(event.key==='Enter') saveCustomSource('${contact.id}')" style="padding: 4px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; width: 120px;">` : 
                                    `<input type="text" id="customSource_${contact.id}" placeholder="Enter custom source..." onblur="saveCustomSource('${contact.id}')" onkeypress="if(event.key==='Enter') saveCustomSource('${contact.id}')" style="display: none; padding: 4px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; width: 120px;">`
                                }
                            </div>
                            <p>üìÖ Added: ${new Date(contact.dateAdded || contact.timestamp || Date.now()).toLocaleDateString()}</p>
                            ${contact.notes || contact.message ? `<p>üìù ${contact.notes || contact.message}</p>` : ''}
                            <p style="font-size: 12px; color: #666;">Collection: ${contact.source}</p>
                        </div>
                        <div>
                            <button onclick="viewContactHistory('${contact.id}', '${contact.source}')" style="margin: 5px; background: #17a2b8;">üëÅÔ∏è History</button>
                            <button onclick="openEmailModal('${contact.id}')" style="margin: 5px;">üìß Send Email</button>
                            ${contact.cellPhone ? '<button onclick="sendSmsToContact(\'' + contact.id + '\', \'' + contact.source + '\')" style="margin: 5px; background: #6f42c1;">üì± Send SMS</button>' : ''}
                            <button onclick="sendDirectMail(\'' + contact.id + '\')" style="margin: 5px; background: #28a745;">üì¨ Send Mail</button>
                            <button onclick="deleteContact('${contact.id}')" style="margin: 5px; background: #dc3545;">üóëÔ∏è Delete</button>
                        </div>
                    </div>
                </div>
                `;
            }).join('');
            
            container.innerHTML = contactsHtml;
        }

        // Add contact function
        async function handleContactSubmit(e) {
            e.preventDefault();
            console.log('üíæ Adding new contact...');
            
            const formData = new FormData(e.target);
            
            // Handle contact source (use custom value if "Custom" is selected)
            let contactSource = formData.get('contactSource');
            if (contactSource === 'Custom') {
                contactSource = formData.get('customContactSource') || 'Custom';
            }
            
            const contactData = {
                name: formData.get('fullName'),
                email: formData.get('email'),
                cellPhone: formData.get('cellPhone'),
                contactSource: contactSource,
                notes: formData.get('notes'),
                newsletter: formData.get('newsletter') === 'on',
                // Address fields for direct mail
                address_line1: formData.get('addressLine1') || '',
                address_line2: formData.get('addressLine2') || '',
                address_city: formData.get('addressCity') || '',
                address_state: formData.get('addressState') || '',
                address_zip: formData.get('addressZip') || '',
                address_country: formData.get('addressCountry') || 'US',
                // Unified contact system fields
                contactType: 'admin_contact',
                source: 'admin',
                dateAdded: new Date().toISOString(),
                status: 'active',
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                const docRef = await db.collection('contacts').add(contactData);
                contactData.id = docRef.id;
                
                // Sync contact to Brevo if they have an email
                if (contactData.email) {
                    console.log('üîÑ Attempting to sync contact to Brevo:', contactData);
                    try {
                        const syncResult = await syncContactToBrevo(contactData);
                        console.log('‚úÖ Contact synced to Brevo successfully:', syncResult);
                        showStatus('‚úÖ Contact added and synced to Brevo successfully', 'success');
                    } catch (brevoError) {
                        console.error('‚ùå Failed to sync contact to Brevo:', brevoError);
                        showStatus('‚úÖ Contact added (Brevo sync failed: ' + brevoError.message + ')', 'success');
                    }
                } else {
                    console.log('‚ö†Ô∏è No email provided, skipping Brevo sync');
                    showStatus('‚úÖ Contact added successfully', 'success');
                }
                
                // Sync contact to PostGrid if they have an address
                if (contactData.address_line1) {
                    console.log('üîÑ Attempting to sync contact to PostGrid:', contactData);
                    try {
                        const postGridResult = await syncContactToPostGrid(contactData);
                        console.log('‚úÖ Contact synced to PostGrid successfully:', postGridResult);
                        showStatus('‚úÖ Contact added and synced to PostGrid successfully', 'success');
                    } catch (postGridError) {
                        console.error('‚ùå Failed to sync contact to PostGrid:', postGridError);
                        showStatus('‚úÖ Contact added (PostGrid sync failed: ' + postGridError.message + ')', 'success');
                    }
                } else {
                    console.log('‚ö†Ô∏è No address provided, skipping PostGrid sync');
                }
                
                allContacts.unshift(contactData);
                displayContacts(allContacts);
                
                clearForm();
                console.log('‚úÖ Contact added successfully');
                
            } catch (error) {
                console.error('‚ùå Error adding contact:', error);
                showStatus(`‚ùå Error adding contact: ${error.message}`, 'error');
            }
        }

        // Export contacts function
        async function exportContacts() {
            try {
                const csvContent = [
                    ['Name', 'Email', 'Phone', 'Source', 'Date Added', 'Address', 'City', 'State', 'Zip', 'PostGrid ID'],
                    ...allContacts.map(contact => [
                        contact.name || '',
                        contact.email || '',
                        contact.cellPhone || '',
                        contact.contactSource || '',
                        contact.dateAdded || '',
                        contact.address_line1 || '',
                        contact.address_city || '',
                        contact.address_state || '',
                        contact.address_zip || '',
                        contact.postGridId || ''
                    ])
                ].map(row => row.map(field => `"${field}"`).join(',')).join('\n');
                
                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `contacts-export-${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                window.URL.revokeObjectURL(url);
                
                showStatus(`‚úÖ Exported ${allContacts.length} contacts`, 'success');
            } catch (error) {
                console.error('‚ùå Error exporting contacts:', error);
                showStatus('‚ùå Error exporting contacts: ' + error.message, 'error');
            }
        }

        // Fix PostGrid ID function
        async function fixPostGridId() {
            if (!confirm('This will update the PostGrid ID for Rich Goward to match the actual PostGrid contact.\n\nContinue?')) return;
            
            try {
                showStatus('üîÑ Fixing PostGrid ID...', 'info');
                
                // Find the Rich Goward contact
                const richContact = allContacts.find(c => c.name === 'Rich Goward');
                if (!richContact) {
                    showStatus('‚ùå Rich Goward contact not found', 'error');
                    return;
                }
                
                // Update with the correct PostGrid ID (the one that actually exists in PostGrid)
                await db.collection('contacts').doc(richContact.id).update({
                    postgridContactId: 'contact_tyimG6Pquky8KyLYcBdseV',
                    postGridId: 'contact_tyimG6Pquky8KyLYcBdseV',
                    postGridSynced: true,
                    postGridSyncedAt: new Date()
                });
                
                // Also update the postgridContacts collection
                const postgridContactRef = db.collection('postgridContacts').doc('contact_tyimG6Pquky8KyLYcBdseV');
                await postgridContactRef.set({
                    firebaseId: richContact.id,
                    postgridId: 'contact_tyimG6Pquky8KyLYcBdseV',
                    createdAt: new Date()
                });
                
                // Reload contacts to reflect changes
                await loadContacts();
                
                showStatus('‚úÖ PostGrid ID updated successfully', 'success');
                
            } catch (error) {
                console.error('‚ùå Error fixing PostGrid ID:', error);
                showStatus('‚ùå Error fixing PostGrid ID: ' + error.message, 'error');
            }
        }

        // Clear sync flags function
        async function clearSyncFlags() {
            if (!confirm('This will clear the PostGrid sync flags for all contacts, allowing them to be re-synced.\n\nContinue?')) return;
            
            try {
                showStatus('üîÑ Clearing sync flags...', 'info');
                
                const batch = db.batch();
                let clearedCount = 0;
                
                // Clear sync flags for all contacts
                for (const contact of allContacts) {
                    const contactRef = db.collection('contacts').doc(contact.id);
                    batch.update(contactRef, {
                        postGridSynced: firebase.firestore.FieldValue.delete(),
                        postGridSyncedAt: firebase.firestore.FieldValue.delete(),
                        postgridContactId: firebase.firestore.FieldValue.delete(),
                        postGridId: firebase.firestore.FieldValue.delete()
                    });
                    clearedCount++;
                }
                
                await batch.commit();
                
                // Reload contacts to reflect changes
                await loadContacts();
                
                showStatus(`‚úÖ Cleared sync flags for ${clearedCount} contacts`, 'success');
                
            } catch (error) {
                console.error('‚ùå Error clearing sync flags:', error);
                showStatus('‚ùå Error clearing sync flags: ' + error.message, 'error');
            }
        }

        // Delete all contacts function
        async function deleteAllContacts() {
            if (!confirm('‚ö†Ô∏è WARNING: This will delete ALL contacts from Firebase and PostGrid!\n\nAre you absolutely sure you want to continue?')) return;
            
            try {
                showStatus('üîÑ Deleting all contacts...', 'info');
                
                const batch = db.batch();
                let deletedCount = 0;
                
                // Delete all contacts from Firebase
                for (const contact of allContacts) {
                    const contactRef = db.collection('contacts').doc(contact.id);
                    batch.delete(contactRef);
                    deletedCount++;
                }
                
                await batch.commit();
                
                // Clear local array
                allContacts = [];
                displayContacts(allContacts);
                
                showStatus(`‚úÖ Deleted ${deletedCount} contacts from Firebase`, 'success');
                
                // Note: PostGrid contacts will be cleaned up when we re-sync
                console.log('‚úÖ All contacts deleted from Firebase');
                
            } catch (error) {
                console.error('‚ùå Error deleting all contacts:', error);
                showStatus('‚ùå Error deleting contacts: ' + error.message, 'error');
            }
        }

        // Delete contact function
        async function deleteContact(contactId) {
            if (!confirm('Are you sure you want to delete this contact?')) return;
            
            try {
                // Get contact data before deleting
                const contactDoc = await db.collection('contacts').doc(contactId).get();
                const contactData = contactDoc.data();
                
                // Delete from Firebase
                await db.collection('contacts').doc(contactId).delete();
                
                // Delete from Brevo if contact has email
                if (contactData && contactData.email) {
                    try {
                        await deleteContactFromBrevo(contactData.email);
                        console.log('‚úÖ Contact deleted from Brevo successfully');
                    } catch (brevoError) {
                        console.error('‚ùå Failed to delete contact from Brevo:', brevoError);
                        showStatus('‚úÖ Contact deleted (Brevo deletion failed: ' + brevoError.message + ')', 'success');
                    }
                }
                
                // Delete from PostGrid if contact has postGridId
                if (contactData && contactData.postGridId) {
                    try {
                        await deleteContactFromPostGrid(contactData.postGridId);
                        console.log('‚úÖ Contact deleted from PostGrid successfully');
                    } catch (postGridError) {
                        console.error('‚ùå Failed to delete contact from PostGrid:', postGridError);
                        showStatus('‚úÖ Contact deleted (PostGrid deletion failed: ' + postGridError.message + ')', 'success');
                    }
                }
                
                allContacts = allContacts.filter(c => c.id !== contactId);
                displayContacts(allContacts);
                showStatus('‚úÖ Contact deleted successfully', 'success');
                console.log('‚úÖ Contact deleted successfully');
            } catch (error) {
                console.error('‚ùå Error deleting contact:', error);
                showStatus(`‚ùå Error deleting contact: ${error.message}`, 'error');
            }
        }

        // Email modal functions
        function openEmailModal(contactId) {
            currentContact = allContacts.find(c => c.id === contactId);
            if (currentContact) {
                document.getElementById('emailModal').style.display = 'block';
                document.getElementById('emailSubject').value = `Follow up - ${currentContact.name}`;
            }
        }

        function closeEmailModal() {
            document.getElementById('emailModal').style.display = 'none';
            document.getElementById('emailForm').reset();
            currentContact = null;
        }

        function loadEmailTemplate() {
            // Template content is handled by Brevo - no local template loading needed
            console.log('Template selected:', document.getElementById('emailTemplate').value);
        }

        async function handleEmailSubmit(e) {
            e.preventDefault();
            
            const subject = document.getElementById('emailSubject').value;
            const templateId = document.getElementById('emailTemplate').value;
            
            if (!currentContact) return;
            
            if (!templateId) {
                showStatus('‚ùå Please select an email template', 'error');
                return;
            }
            
            try {
                const emailData = {
                    toEmail: currentContact.email,
                    toName: currentContact.name || currentContact.fullName,
                    templateId: templateId,
                    subject: subject,
                    templateVariables: {
                        NAME: currentContact.name || currentContact.fullName,
                        FIRSTNAME: (currentContact.name || currentContact.fullName || '').split(' ')[0]
                    }
                };

                const response = await fetch('https://us-central1-realinvestco-web.cloudfunctions.net/sendBrevoTemplateEmail', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(emailData)
                });

                if (response.ok) {
                    const result = await response.json();
                    showStatus('‚úÖ Email sent successfully using Brevo template', 'success');
                    closeEmailModal();
                } else {
                    const errorData = await response.json();
                    showStatus('‚ùå Error sending email: ' + (errorData.error || 'Unknown error'), 'error');
                }
                
            } catch (error) {
                console.error('Error sending email:', error);
                showStatus('‚ùå Error sending email: ' + error.message, 'error');
            }
        }

        // Clear form function
        function clearForm() {
            document.getElementById('contactForm').reset();
        }

        // Show status function
        function showStatus(message, type) {
            const container = document.getElementById('statusContainer');
            const statusDiv = document.createElement('div');
            statusDiv.className = `${type}`;
            statusDiv.textContent = message;
            
            container.appendChild(statusDiv);
            
            setTimeout(() => {
                statusDiv.remove();
            }, 5000);
        }

        // Filter contacts function
        function filterContacts() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const filtered = allContacts.filter(contact => 
                (contact.name && contact.name.toLowerCase().includes(searchTerm)) ||
                (contact.email && contact.email.toLowerCase().includes(searchTerm)) ||
                (contact.cellPhone && contact.cellPhone.includes(searchTerm)) ||
                (contact.contactSource && contact.contactSource.toLowerCase().includes(searchTerm))
            );
            displayContacts(filtered);
        }

        // Brevo integration functions
        async function syncContactToBrevo(contactData) {
            try {
                console.log('üîÑ syncContactToBrevo called with data:', contactData);
                
                const requestData = {
                    email: contactData.email,
                    name: contactData.name,
                    phone: contactData.cellPhone,
                    attributes: {
                        contactSource: contactData.contactSource,
                        contactType: contactData.contactType,
                        newsletter: contactData.newsletter || false,
                        smsOptIn: contactData.smsOptIn || false
                    }
                };
                
                console.log('üì§ Sending request to syncContactToBrevo:', requestData);
                
                const response = await fetch('https://us-central1-realinvestco-web.cloudfunctions.net/syncContactToBrevo', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });

                console.log('üì• Response status:', response.status);
                console.log('üì• Response ok:', response.ok);

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('‚ùå Brevo sync error response:', errorData);
                    throw new Error(errorData.error || 'Failed to sync to Brevo');
                }

                const result = await response.json();
                console.log('‚úÖ Brevo sync successful:', result);
                return result;
            } catch (error) {
                console.error('‚ùå Error syncing contact to Brevo:', error);
                throw error;
            }
        }

        async function syncContactToPostGrid(contactData) {
            try {
                console.log('üîÑ syncContactToPostGrid called with data:', contactData);
                
                const requestData = {
                    contactData: contactData
                };
                
                console.log('üì§ Sending request to syncContactToPostGrid:', requestData);
                
                const response = await fetch('https://us-central1-realinvestco-web.cloudfunctions.net/syncContactToPostGrid', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });

                console.log('üì• Response status:', response.status);
                console.log('üì• Response ok:', response.ok);

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('‚ùå PostGrid sync error response:', errorData);
                    throw new Error(errorData.error || 'Failed to sync to PostGrid');
                }

                const result = await response.json();
                console.log('‚úÖ PostGrid sync successful:', result);
                return result;
            } catch (error) {
                console.error('‚ùå Error syncing contact to PostGrid:', error);
                throw error;
            }
        }

        async function deleteContactFromBrevo(email) {
            try {
                console.log('üîÑ deleteContactFromBrevo called with email:', email);
                
                const requestData = {
                    email: email
                };
                
                console.log('üì§ Sending request to deleteContactFromBrevo:', requestData);
                
                const response = await fetch('https://us-central1-realinvestco-web.cloudfunctions.net/deleteContactFromBrevo', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });

                console.log('üì• Response status:', response.status);
                console.log('üì• Response ok:', response.ok);

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('‚ùå Brevo deletion error response:', errorData);
                    throw new Error(errorData.error || 'Failed to delete from Brevo');
                }

                const result = await response.json();
                console.log('‚úÖ Brevo deletion successful:', result);
                return result;
            } catch (error) {
                console.error('‚ùå Error deleting contact from Brevo:', error);
                throw error;
            }
        }

        async function deleteContactFromPostGrid(postGridId) {
            try {
                console.log('üîÑ deleteContactFromPostGrid called with postGridId:', postGridId);
                
                // Get current environment and API key from Firebase settings
                const settingsDoc = await db.collection('mailSettings').doc('config').get();
                const settings = settingsDoc.exists ? settingsDoc.data() : {};
                const environment = settings.postgridEnvironment || 'test';
                const apiKey = environment === 'test' 
                    ? settings.postgridTestApiKey 
                    : settings.postgridLiveApiKey;
                    
                if (!apiKey) {
                    console.warn('PostGrid API key not configured, skipping PostGrid deletion');
                    return;
                }
                
                const requestData = {
                    apiKey: apiKey,
                    postGridId: postGridId
                };
                
                console.log('üì§ Sending request to deleteContactFromPostGrid:', requestData);
                
                const response = await fetch('https://us-central1-realinvestco-web.cloudfunctions.net/deleteContactFromPostGrid', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });

                console.log('üì• Response status:', response.status);
                console.log('üì• Response ok:', response.ok);

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('‚ùå PostGrid deletion error response:', errorData);
                    throw new Error(errorData.error || 'Failed to delete from PostGrid');
                }

                const result = await response.json();
                console.log('‚úÖ PostGrid deletion successful:', result);
                return result;
            } catch (error) {
                console.error('‚ùå Error deleting contact from PostGrid:', error);
                throw error;
            }
        }

        async function loadBrevoTemplates() {
            try {
                console.log('Loading Brevo templates...');
                const templateSelect = document.getElementById('emailTemplate');
                templateSelect.innerHTML = '<option value="">Select Brevo template...</option>';
                
                const response = await fetch('https://us-central1-realinvestco-web.cloudfunctions.net/getBrevoTemplates');
                if (response.ok) {
                    const templates = await response.json();
                    
                    if (templates && templates.length > 0) {
                        templates.forEach(template => {
                            const option = document.createElement('option');
                            option.value = template.id;
                            option.textContent = template.name;
                            templateSelect.appendChild(option);
                        });
                        console.log(`‚úÖ Loaded ${templates.length} Brevo templates`);
                        showStatus('‚úÖ Brevo templates loaded successfully!', 'success');
                    } else {
                        console.log('No templates found in Brevo');
                        showStatus('‚ö†Ô∏è No templates found in Brevo', 'error');
                    }
                } else {
                    console.error('Error loading Brevo templates:', response.status);
                    showStatus('‚ùå Error loading Brevo templates', 'error');
                }
            } catch (error) {
                console.error('Error loading Brevo templates:', error);
                showStatus('‚ùå Error loading Brevo templates: ' + error.message, 'error');
            }
        }

        // Email template functions
        async function loadEmailTemplates() {
            console.log('Loading email templates...');
        }

        async function saveEmailTemplates() {
            console.log('Saving email templates...');
            showStatus('‚úÖ Email templates saved successfully', 'success');
        }

        // Initialize when page loads
        let pageInitialized = false;
        document.addEventListener('DOMContentLoaded', function() {
            if (pageInitialized) {
                console.log('‚ö†Ô∏è Page already initialized, skipping...');
                return;
            }
            pageInitialized = true;
            
            // Clear all local storage cache
            try {
                localStorage.clear();
                sessionStorage.clear();
                console.log('‚úÖ Local storage cleared');
            } catch (e) {
                console.log('Cache clear warning:', e);
            }
            
            console.log('üöÄ Admin contacts page loaded');
            
            loadBrevoTemplates();
            loadEmailTemplates();
            
            // Set up form submission
            document.getElementById('contactForm').addEventListener('submit', handleContactSubmit);
            document.getElementById('emailForm').addEventListener('submit', handleEmailSubmit);
            document.getElementById('searchInput').addEventListener('input', filterContacts);
            
            // Load contacts after a short delay
            setTimeout(() => {
                loadContacts();
            }, 1000);
        });
        
        // Send direct mail function (placeholder for PostGrid integration)
        function sendDirectMail(contactId) {
            // Redirect to contact detail page for mail sending
            window.location.href = `contact-detail.html?id=${contactId}`;
        }

        // Send SMS to individual contact
        async function sendSmsToContact(contactId, collectionName) {
            try {
                const doc = await db.collection(collectionName).doc(contactId).get();
                if (!doc.exists) {
                    showStatus('Contact not found', 'error');
                    return;
                }

                const contact = doc.data();
                if (!contact.cellPhone) {
                    showStatus('No phone number available for this contact', 'error');
                    return;
                }

                const message = prompt('Enter SMS message:', `Hi ${contact.name || 'there'}, thanks for your interest in Real InvestCo properties!`);
                if (!message) return;

                const response = await fetch('https://us-central1-realinvestco-web.cloudfunctions.net/sendSmsWebhook', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        smsType: 'manual',
                        contactData: {
                            contactId: contactId,
                            name: contact.name,
                            phone: contact.cellPhone,
                            email: contact.email,
                            propertyId: contact.propertyId || null
                        },
                        customMessage: message
                    })
                });

                if (response.ok) {
                    showStatus('SMS sent successfully!', 'success');
                } else {
                    const errorData = await response.json();
                    showStatus('Error sending SMS: ' + errorData.error, 'error');
                }

            } catch (error) {
                console.error('Error sending SMS:', error);
                showStatus('Error sending SMS: ' + error.message, 'error');
            }
        }

        // Navigate to Contact Detail Page
        window.viewContactHistory = function(contactId, collection) {
            // Navigate to the contact detail page instead of opening a modal
            window.location.href = `contact-detail.html?id=${contactId}&collection=${collection}`;
        };

        // Contact History Modal functionality (kept for backward compatibility)
        window.viewContactHistoryModal = async function(contactId, collection) {
            try {
                // Always use 'contacts' collection since we unified all contacts
                const doc = await db.collection('contacts').doc(contactId).get();
                if (!doc.exists) {
                    showStatus('Contact not found', 'error');
                    return;
                }

                const contact = doc.data();
                const modal = document.getElementById('historyModal');
                const modalTitle = document.getElementById('modalTitle');
                const modalContent = document.getElementById('modalContent');

                modalTitle.textContent = `Contact History - ${contact.name || contact.fullName}`;

                // Get all interactions for this contact
                const interactions = [];
                
                // Check all collections for this contact
                const collections = ['generalInquiries', 'propertyInquiries', 'contacts'];
                for (const col of collections) {
                    const snapshot = await db.collection(col).where('email', '==', contact.email).get();
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        interactions.push({
                            timestamp: data.timestamp || data.dateAdded,
                            type: col === 'contacts' ? 'Admin Contact' : 
                                  col === 'propertyInquiries' ? 'Property Inquiry' : 'General Inquiry',
                            message: data.message || data.notes || data.contactNotes || 'No message',
                            propertyTitle: data.propertyTitle || data.propertyId || null,
                            source: data.contactSource || data.source || 'Unknown'
                        });
                    });
                }

                // Sort by timestamp
                interactions.sort((a, b) => {
                    const timeA = a.timestamp?.toMillis ? a.timestamp.toMillis() : new Date(a.timestamp).getTime();
                    const timeB = b.timestamp?.toMillis ? b.timestamp.toMillis() : new Date(b.timestamp).getTime();
                    return timeB - timeA;
                });

                modalContent.innerHTML = `
                    <div style="margin-bottom: 20px;">
                        <h4>Contact Information</h4>
                        <p><strong>Name:</strong> ${contact.name || contact.fullName}</p>
                        <p><strong>Email:</strong> ${contact.email}</p>
                        <p><strong>Phone:</strong> ${contact.cellPhone || contact.phone || 'N/A'}</p>
                        ${contact.address_line1 ? `
                            <p><strong>Address:</strong> ${contact.address_line1}${contact.address_line2 ? ', ' + contact.address_line2 : ''}</p>
                            <p><strong>City/State/ZIP:</strong> ${contact.address_city}, ${contact.address_state} ${contact.address_zip}</p>
                        ` : '<p><strong>Address:</strong> Not provided</p>'}
                        <p><strong>Newsletter:</strong> ${contact.newsletter ? 'Yes' : 'No'}</p>
                        <p><strong>SMS Opt-in:</strong> ${contact.smsOptIn ? 'Yes' : 'No'}</p>
                    </div>
                    
                    <div>
                        <h4>Interaction History (${interactions.length} interactions)</h4>
                        ${interactions.length === 0 ? '<p>No interactions found.</p>' : 
                            interactions.map(interaction => `
                                <div style="border-left: 3px solid #007cba; padding-left: 15px; margin-bottom: 15px;">
                                    <p><strong>${interaction.type}</strong> - ${new Date(interaction.timestamp?.toMillis ? interaction.timestamp.toMillis() : interaction.timestamp).toLocaleString()}</p>
                                    ${interaction.propertyTitle ? `<p><strong>Property:</strong> ${interaction.propertyTitle}</p>` : ''}
                                    <p><strong>Source:</strong> ${interaction.source}</p>
                                    <p><strong>Message:</strong> ${interaction.message}</p>
                                </div>
                            `).join('')
                        }
                    </div>
                `;

                modal.style.display = 'block';

            } catch (error) {
                console.error('Error loading contact history:', error);
                showStatus('Error loading contact history', 'error');
            }
        }

        // Close modal functionality
        window.onclick = function(event) {
            const modal = document.getElementById('historyModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }

        document.querySelector('.close').onclick = function() {
            document.getElementById('historyModal').style.display = 'none';
        }

        // Update contact source function
        async function updateContactSource(contactId) {
            const sourceSelect = document.getElementById(`sourceSelect_${contactId}`);
            const customSourceInput = document.getElementById(`customSource_${contactId}`);
            
            // Handle dropdown change
            if (sourceSelect.value === 'Custom') {
                customSourceInput.style.display = 'inline-block';
                customSourceInput.focus();
                return; // Don't save yet, wait for custom input
            } else {
                customSourceInput.style.display = 'none';
            }
            
            const newSource = sourceSelect.value;
            
            try {
                // Update the contact in Firebase
                await db.collection('contacts').doc(contactId).update({
                    contactSource: newSource,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Update the contact in the local array
                const contactIndex = allContacts.findIndex(c => c.id === contactId);
                if (contactIndex !== -1) {
                    allContacts[contactIndex].contactSource = newSource;
                }
                
                showStatus('‚úÖ Contact source updated successfully!', 'success');
                console.log(`‚úÖ Updated contact ${contactId} source to: ${newSource}`);
            } catch (error) {
                console.error('Error updating contact source:', error);
                showStatus('‚ùå Failed to update source. Please try again.', 'error');
                // Revert the dropdown
                sourceSelect.value = allContacts.find(c => c.id === contactId)?.contactSource || 'RIC CA Activity';
            }
        }
        
        // Handle new contact source dropdown change
        function handleNewContactSourceChange() {
            const sourceSelect = document.getElementById('contactSource');
            const customInput = document.getElementById('customContactSource');
            
            if (sourceSelect.value === 'Custom') {
                customInput.style.display = 'block';
                customInput.required = true;
                customInput.focus();
            } else {
                customInput.style.display = 'none';
                customInput.required = false;
                customInput.value = '';
            }
        }

        // Save custom source function
        async function saveCustomSource(contactId) {
            const customSourceInput = document.getElementById(`customSource_${contactId}`);
            const sourceSelect = document.getElementById(`sourceSelect_${contactId}`);
            
            const newSource = customSourceInput.value.trim();
            if (!newSource) {
                showStatus('‚ùå Please enter a custom source value.', 'error');
                return;
            }
            
            try {
                // Update the contact in Firebase
                await db.collection('contacts').doc(contactId).update({
                    contactSource: newSource,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Update the contact in the local array
                const contactIndex = allContacts.findIndex(c => c.id === contactId);
                if (contactIndex !== -1) {
                    allContacts[contactIndex].contactSource = newSource;
                }
                
                showStatus('‚úÖ Custom source updated successfully!', 'success');
                console.log(`‚úÖ Updated contact ${contactId} source to: ${newSource}`);
            } catch (error) {
                console.error('Error updating custom source:', error);
                showStatus('‚ùå Failed to update source. Please try again.', 'error');
            }
        }

        console.log('‚úÖ Admin contacts script loaded');
    </script>

    <!-- Service Worker Registration -->
    <script>
    (function () {
      if (!('serviceWorker' in navigator)) return;

      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/service-worker.js').then((reg) => {
          // If there's an updated SW waiting, prompt user
          function promptRefresh(worker) {
            // Replace with a nicer UI if you want
            if (confirm('A new version is available. Refresh now?')) {
              worker.postMessage({ type: 'SKIP_WAITING' });
            }
          }

          // Waiting SW = an update is ready
          if (reg.waiting) {
            promptRefresh(reg.waiting);
          }

          // New SW found, it'll be waiting after installing
          reg.addEventListener('updatefound', () => {
            const newWorker = reg.installing;
            if (!newWorker) return;
            newWorker.addEventListener('statechange', () => {
              if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                promptRefresh(newWorker);
              }
            });
          });

          // Reload the page when the new SW becomes the controller
          navigator.serviceWorker.addEventListener('controllerchange', () => {
            window.location.reload();
          });
        }).catch((err) => {
          console.warn('SW registration failed:', err);
        });
      });
    })();
    </script>

    <!-- Contact History Modal -->
    <div id="historyModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
        <div style="background-color: white; margin: 5% auto; padding: 30px; border-radius: 12px; width: 80%; max-width: 800px; max-height: 80vh; overflow-y: auto;">
            <span class="close" style="color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
            <h3 id="modalTitle">Contact History</h3>
            <div id="modalContent"></div>
        </div>
    </div>

</body>
</html>