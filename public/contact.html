<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Contact Real InvestCo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="styles.css">
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <style>
    body, html { margin: 0; padding: 0; font-family: 'Segoe UI', Arial, sans-serif; background: #f4f6fb; }
    .contact-section { padding: 80px 20px; background: #fff; min-height: 100vh; display: flex; align-items: center; justify-content: center; }
    .contact-container { max-width: 1400px; width: 100%; display: flex; gap: 24px; align-items: flex-start; justify-content: center; }
    .contact-info { flex: 0 0 350px; background: #fff; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); padding: 40px; border: 1px solid #eee; }
    .contact-info h2 { margin: 0 0 24px 0; font-size: 2em; font-weight: 700; color: #1A237E; }
    .contact-info p { font-size: 1.1em; color: #333; line-height: 1.6; margin-bottom: 20px; }
    .contact-card { background: #fff; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); padding: 40px; max-width: 400px; min-width: 400px; border: 1px solid #eee; flex: 0 0 400px; }
    .ppp-card { background: #fff; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); padding: 40px; max-width: 400px; min-width: 400px; border: 1px solid #eee; flex: 0 0 400px; display: none; }
    .ppp-card.visible { display: block; }
    .contact-card h3 { margin: 0 0 24px 0; font-size: 1.5em; font-weight: 600; color: #1A237E; }
    .contact-form { display: flex; flex-direction: column; gap: 12px; }
    .form-group { display: flex; flex-direction: column; gap: 4px; margin-bottom: 0; }
    .form-group label { font-weight: 500; color: #333; font-size: 0.95em; }
    .form-group input, .form-group textarea { padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.95em; transition: border-color 0.2s; }
    .form-group input:focus, .form-group textarea:focus { outline: none; border-color: #1A237E; }
    .form-row { display: flex; gap: 15px; margin-bottom: 12px; align-items: end; }
    .form-row .form-group { flex: 1; }
    .form-row .form-group[style*="width"] { flex: none !important; }
    .checkbox-label { display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 0.95em; }
    .checkbox-label input[type="checkbox"] { width: 16px; height: 16px; }
    .submit-button { background: #1A237E; color: white; border: none; padding: 12px 24px; border-radius: 6px; font-size: 1em; font-weight: 500; cursor: pointer; transition: background-color 0.2s; margin-top: 4px; }
    .submit-button:hover { background: #283593; }
    @media (max-width: 1200px) { 
      .contact-container { flex-direction: column; align-items: center; } 
      .contact-info, .contact-card, .ppp-card { max-width: 100%; min-width: unset; } 
    }
    .link-bar {
        position: absolute;
        top: 30px;
        left: 900px;
        background: #1A237E;
        border-radius: 6px;
        box-shadow: 0 4px 24px rgba(0,0,0,0.08);
        padding: 10px 24px 8px 24px;
        display: flex;
        gap: 28px;
        z-index: 10;
    }
    .link-bar a {
        color: #fff;
        text-decoration: none;
        font-weight: 700;
        font-size: 1.15em;
        transition: color 0.2s;
    }
    .link-bar a:hover {
        color: #FFD700;
        text-shadow: 0 2px 8px rgba(26,144,255,0.15);
    }
    @media (max-width: 600px) {
        .link-bar {
            position: static;
            margin: 0 auto 16px auto;
            padding: 10px 5vw 5px 5vw;
            flex-direction: column;
            align-items: flex-start;
            gap: 12px;
        }
    }
  </style>
</head>
<body>

  <nav class="link-bar">
    <a href="index.html">Home</a>
    <a href="properties.html">Properties</a>
    <a href="properties-table.html">Properties Spreadsheet</a>
    <a href="contact.html">Contact US</a>
  </nav>
  <section class="contact-section">
    <div class="contact-container">
      <div class="contact-info">
        <h2>Contact Real InvestCo</h2>
        <p>Our mission is to help you find the property investment opportunities you are looking for.</p>
        <p>Whether you're looking for wholesale properties, fix-and-flip opportunities, or long-term investments, our team is ready to assist you.</p>
        <p>Fill out the form on the right and we'll get back to you within 24 hours.</p>
      </div>
      <div class="contact-card">
        <h3>Inquiry Form</h3>
        <div id="propertyTitleDisplay" style="display:none; font-weight:600; color:#1A237E; margin-bottom:12px;"></div>
        <div id="form-container">
          <form id="contactForm" class="contact-form">
            <input type="hidden" id="propertyId" name="propertyId" value="">
            <div class="form-group">
              <label for="name">Full Name *</label>
              <input type="text" id="name" name="name" required>
            </div>
            <div class="form-group">
              <label for="email">Email Address (Optional)</label>
              <input type="email" id="email" name="email">
            </div>
            <div class="form-group">
              <label for="cellPhone">Cell Phone (Optional)</label>
              <input type="tel" id="cellPhone" name="cellPhone">
            </div>
            <div class="form-group">
              <label for="landline">Landline Phone</label>
              <input type="tel" id="landline" name="landline">
            </div>
            
            <div class="form-group">
              <label for="contactSource">How did you hear about us? *</label>
              <select id="contactSource" name="contactSource" required>
                <option value="">Select source...</option>
                <option value="Facebook">Facebook</option>
                <option value="LinkedIn">LinkedIn</option>
                <option value="Email">Email</option>
                <option value="Text/SMS">Text/SMS</option>
                <option value="Postal Mail">Postal Mail</option>
                <option value="Referral">Referral</option>
                <option value="Google Search">Google Search</option>
                <option value="Other">Other</option>
              </select>
            </div>
            
            <div class="form-group" id="customSourceGroup" style="display: none;">
              <label for="customSource">Please specify:</label>
              <input type="text" id="customSource" name="customSource" placeholder="Enter source...">
            </div>
            
            <!-- Address Fields -->
            <div style="margin-top: 20px;">
              <h4 style="color: #1A237E; margin-bottom: 15px;">üì¨ Mailing Address (Optional)</h4>
              <div class="form-group">
                <label for="address_line1">Street Address</label>
                <input type="text" id="address_line1" name="address_line1">
              </div>
              <div class="form-group">
                <label for="address_line2">Apt/Suite/Unit</label>
                <input type="text" id="address_line2" name="address_line2">
              </div>
              <div class="form-group">
                <label for="address_city">City</label>
                <input type="text" id="address_city" name="address_city">
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label for="address_state">State</label>
                  <input type="text" id="address_state" name="address_state" maxlength="2" style="width: 80px;">
                </div>
                <div class="form-group">
                  <label for="address_zip">ZIP Code</label>
                  <input type="text" id="address_zip" name="address_zip" maxlength="5" style="width: 120px;">
                </div>
              </div>
            </div>
            
            <div class="form-group">
              <label for="message">Message</label>
              <textarea id="message" name="message" rows="4" placeholder="Provide any details here that you want to share."></textarea>
            </div>
            
            <div class="form-group">
              <label class="checkbox-label">
                <input type="checkbox" name="newsletter" id="newsletter">
                Click to subscribe for new properties and property updates
              </label>
            </div>
            <div class="form-group">
              <p style="font-size: 0.85em; color: #555; margin: 8px 0; line-height: 1.4;">
                By checking this box and clicking "SEND" you consent to receive transactional text messages for notifications and alerts from Real InvestCo. Reply STOP to opt out. Reply HELP for help. Message and data rates may apply. Message frequency may vary.
              </p>
            </div>
            <div class="form-group">
              <label class="checkbox-label">
                <input type="checkbox" name="smsOptIn" id="smsOptIn">
                I agree to receive SMS updates from Real InvestCo
              </label>
              <p style="font-size: 0.8em; color: #666; margin-top: 5px; line-height: 1.3;">
                By checking this box and clicking "SEND," you consent to receive marketing text messages for marketing and promotional offers from Real InvestCo. Reply STOP to opt out. Reply HELP for help. Message and data rates may apply.
              </p>
            </div>
            <div class="form-group">
              <label class="checkbox-label">
                <input type="checkbox" name="termsAgreement" id="termsAgreement" required>
                I agree to the <a href="terms-conditions.html" style="color: #1A237E; text-decoration: underline;">Terms and Conditions and Privacy Policy</a>
              </label>
            </div>
            <button type="submit" class="submit-button">Send Message</button>
          </form>
        </div>
        <div id="form-success-message" style="display: none; text-align: center; padding: 40px; border: 1px solid #c8e6c9; background-color: #f1f8e9; border-radius: 8px;">
          <h4 style="color: #388e3c; font-size: 1.5em; margin-top: 0;">Thank you!</h4>
          <p id="success-property-title" style="font-weight:600; color:#1A237E; display:none;"></p>
          <p>Your message has been sent successfully. We will get back to you within 24 hours.</p>
          <button id="continue-button" class="submit-button">Continue</button>
        </div>
      </div>
      
      <!-- PPP Card (Right side) -->
      <div id="pppCard" class="ppp-card visible">
        <p style="font-size: 0.9em; color: #666; margin-bottom: 20px; line-height: 1.4; font-style: italic;">
          Help us find the perfect investment property by providing your specific criteria.
        </p>
        <h3>üè† Perfect Property Profile</h3>
        <div class="contact-form">
          <div style="display: flex; gap: 15px; margin-bottom: 15px;">
            <div style="flex: 1;">
              <label for="pppBedrooms">Bedrooms</label>
              <select id="pppBedrooms" name="pppBedrooms" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <option value="">Select...</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5+</option>
              </select>
            </div>
            <div style="flex: 1;">
              <label for="pppBathrooms">Bathrooms</label>
              <select id="pppBathrooms" name="pppBathrooms" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <option value="">Select...</option>
                <option value="1">1</option>
                <option value="1.5">1.5</option>
                <option value="2">2</option>
                <option value="2.5">2.5</option>
                <option value="3">3</option>
                <option value="3.5">3.5</option>
                <option value="4">4+</option>
              </select>
            </div>
          </div>

          <div style="display: flex; gap: 15px; margin-bottom: 15px;">
            <div style="flex: 1;">
              <label for="pppSquareFootageFrom">Sq Feet From</label>
              <input type="number" id="pppSquareFootageFrom" name="pppSquareFootageFrom" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div style="flex: 1;">
              <label for="pppSquareFootageTo">Sq Feet To</label>
              <input type="number" id="pppSquareFootageTo" name="pppSquareFootageTo" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
          </div>

          <div style="display: flex; gap: 15px; margin-bottom: 15px;">
            <div style="flex: 1;">
              <label for="pppLotSizeFrom">Lot From (sq ft)</label>
              <input type="number" id="pppLotSizeFrom" name="pppLotSizeFrom" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div style="flex: 1;">
              <label for="pppLotSizeTo">Lot To (sq ft)</label>
              <input type="number" id="pppLotSizeTo" name="pppLotSizeTo" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
          </div>

          <div style="display: flex; gap: 15px; margin-bottom: 15px;">
            <div style="flex: 1;">
              <label for="pppLotAcreFrom">Lot Acre From</label>
              <input type="number" id="pppLotAcreFrom" name="pppLotAcreFrom" placeholder="e.g., 0.25" step="0.01" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div style="flex: 1;">
              <label for="pppLotAcreTo">Lot Acre To</label>
              <input type="number" id="pppLotAcreTo" name="pppLotAcreTo" placeholder="e.g., 0.5" step="0.01" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
          </div>

          <div style="display: flex; gap: 15px; margin-bottom: 15px;">
            <div style="flex: 1;">
              <label for="pppCounty">County</label>
              <input type="text" id="pppCounty" name="pppCounty" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div style="flex: 1;">
              <label for="pppCity">City</label>
              <input type="text" id="pppCity" name="pppCity" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
          </div>

          <div style="display: flex; gap: 15px; margin-bottom: 15px;">
            <div style="flex: 1;">
              <label for="pppWholesalePriceFrom">Wholesale Cost Price From</label>
              <input type="number" id="pppWholesalePriceFrom" name="pppWholesalePriceFrom" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div style="flex: 1;">
              <label for="pppWholesalePriceTo">Wholesale Cost Price To</label>
              <input type="number" id="pppWholesalePriceTo" name="pppWholesalePriceTo" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
          </div>

          <div style="margin-bottom: 15px;">
            <label>Property Types (check all that apply)</label>
            <div style="margin-top: 8px;">
              <label style="display: inline-block; margin-right: 20px; font-weight: normal;">
                <input type="checkbox" name="pppPropertyTypes" value="single-family"> Single Family
              </label>
              <label style="display: inline-block; margin-right: 20px; font-weight: normal;">
                <input type="checkbox" name="pppPropertyTypes" value="condo"> Condo
              </label>
              <label style="display: inline-block; margin-right: 20px; font-weight: normal;">
                <input type="checkbox" name="pppPropertyTypes" value="townhouse"> Townhouse
              </label>
              <label style="display: inline-block; font-weight: normal;">
                <input type="checkbox" name="pppPropertyTypes" value="multi-family"> Multi-Family
              </label>
            </div>
          </div>

          <div style="margin-bottom: 15px;">
            <label for="pppInvestmentGoals">Investment Goals</label>
            <textarea id="pppInvestmentGoals" name="pppInvestmentGoals" rows="3" placeholder="Tell us about your investment strategy, timeline, and any specific requirements..." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"></textarea>
          </div>
        </div>
      </div>
    </div>
  </section>
  <script>
    // Firebase config and initialization
    const firebaseConfig = {
      apiKey: "AIzaSyDXifeppD7kBgpgwu74Aa-5h6t_4ieFwq0",
      authDomain: "realinvestco-web.firebaseapp.com",
      projectId: "realinvestco-web",
      storageBucket: "realinvestco-web.firebasestorage.app",
      messagingSenderId: "1021426656860",
      appId: "1:1021426656860:web:1a1f9cb16b3f0a2158a899",
      measurementId: "G-X30NR9MZGP"
    };
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.firestore();

    // Auto-fill propertyId if present in URL
    const urlParams = new URLSearchParams(window.location.search);
    let propId = urlParams.get('propertyId');
    if (propId) {
      // If propId is not a number, treat as docId and look up the property
      if (isNaN(Number(propId))) {
        db.collection('properties').doc(propId).get().then(doc => {
          if (doc.exists) {
            const data = doc.data();
            if (data.id) {
              document.getElementById('propertyId').value = data.id;
              window._propertyTitle = data.title || '';
              // Show property title
              const titleDiv = document.getElementById('propertyTitleDisplay');
              if (window._propertyTitle) {
                titleDiv.textContent = `Inquiry about: ${window._propertyTitle}`;
                titleDiv.style.display = 'block';
              }
            }
          }
        });
      } else {
        document.getElementById('propertyId').value = propId;
        // Fetch property title from Firestore
        db.collection('properties').where('id', '==', Number(propId)).get().then(snapshot => {
          if (!snapshot.empty) {
            const data = snapshot.docs[0].data();
            const title = data.title || '';
            if (title) {
              const titleDiv = document.getElementById('propertyTitleDisplay');
              titleDiv.textContent = `Inquiry about: ${title}`;
              titleDiv.style.display = 'block';
              window._propertyTitle = title;
            }
          }
        });
      }
    }


    const contactForm = document.getElementById('contactForm');
    const formContainer = document.getElementById('form-container');
    const formSuccess = document.getElementById('form-success-message');
    const continueBtn = document.getElementById('continue-button');

    // Handle source dropdown change
    document.getElementById('contactSource').addEventListener('change', function() {
      const customSourceGroup = document.getElementById('customSourceGroup');
      if (this.value === 'Other') {
        customSourceGroup.style.display = 'block';
        document.getElementById('customSource').required = true;
      } else {
        customSourceGroup.style.display = 'none';
        document.getElementById('customSource').required = false;
        document.getElementById('customSource').value = '';
      }
    });

    contactForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = e.target;
      const submitButton = form.querySelector('.submit-button');
      submitButton.disabled = true;
      submitButton.textContent = 'Sending...';

      // Get source value
      const contactSource = form.contactSource.value;
      const customSource = form.customSource.value.trim();
      const finalSource = contactSource === 'Other' ? customSource : contactSource;

      const formData = {
        propertyId: form.propertyId.value.trim(),
        propertyTitle: window._propertyTitle || '',
        name: form.name.value.trim(),
        email: form.email.value.trim(),
        cellPhone: form.cellPhone.value.trim(),
        landline: form.landline.value.trim(),
        message: form.message.value.trim(),
        source: finalSource,
        // Address fields
        address_line1: form.address_line1 ? form.address_line1.value.trim() : '',
        address_line2: form.address_line2 ? form.address_line2.value.trim() : '',
        address_city: form.address_city ? form.address_city.value.trim() : '',
        address_state: form.address_state ? form.address_state.value.trim() : '',
        address_zip: form.address_zip ? form.address_zip.value.trim() : '',
        address_country: 'US', // Default to US
        newsletter: form.newsletter ? form.newsletter.checked : false,
        smsOptIn: form.smsOptIn ? form.smsOptIn.checked : false,
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      };

      // Check if PPP data is actually filled out
      const pppBedrooms = document.getElementById('pppBedrooms').value;
      const pppBathrooms = document.getElementById('pppBathrooms').value;
      const pppSquareFootageFrom = document.getElementById('pppSquareFootageFrom').value;
      const pppSquareFootageTo = document.getElementById('pppSquareFootageTo').value;
      const pppCounty = document.getElementById('pppCounty').value;
      const pppCity = document.getElementById('pppCity').value;
      
      // Check if any required PPP fields are filled out
      const pppCompleted = pppBedrooms || pppBathrooms || pppSquareFootageFrom || pppSquareFootageTo || pppCounty || pppCity;
      
      if (pppCompleted) {
        const pppData = {
          bedrooms: pppBedrooms,
          bathrooms: pppBathrooms,
          squareFootageFrom: pppSquareFootageFrom ? parseInt(pppSquareFootageFrom) : null,
          squareFootageTo: pppSquareFootageTo ? parseInt(pppSquareFootageTo) : null,
          lotSizeFrom: document.getElementById('pppLotSizeFrom').value ? parseInt(document.getElementById('pppLotSizeFrom').value) : null,
          lotSizeTo: document.getElementById('pppLotSizeTo').value ? parseInt(document.getElementById('pppLotSizeTo').value) : null,
          lotAcreFrom: document.getElementById('pppLotAcreFrom').value ? parseFloat(document.getElementById('pppLotAcreFrom').value) : null,
          lotAcreTo: document.getElementById('pppLotAcreTo').value ? parseFloat(document.getElementById('pppLotAcreTo').value) : null,
          county: pppCounty,
          city: pppCity,
          wholesalePriceFrom: document.getElementById('pppWholesalePriceFrom').value ? parseInt(document.getElementById('pppWholesalePriceFrom').value) : null,
          wholesalePriceTo: document.getElementById('pppWholesalePriceTo').value ? parseInt(document.getElementById('pppWholesalePriceTo').value) : null,
          propertyTypes: Array.from(document.querySelectorAll('input[name="pppPropertyTypes"]:checked')).map(cb => cb.value),
          investmentGoals: document.getElementById('pppInvestmentGoals').value,
          timestamp: firebase.firestore.FieldValue.serverTimestamp(),
          source: 'contact_form_ppp'
        };
        formData.pppProfile = pppData;
        formData.pppCompleted = true;
      } else {
        formData.pppCompleted = false;
      }

      try {
        // Validate required fields (name is required, and either email or phone is required)
        if (!formData.name) {
          throw new Error('Please fill in your name.');
        }
        if (!formData.email && !formData.cellPhone && !formData.landline) {
          throw new Error('Please provide either an email address or phone number so we can contact you.');
        }
        // If phone is provided, require SMS opt-in to send text confirmation
        if ((formData.cellPhone || formData.landline) && !formData.smsOptIn) {
          throw new Error('To receive a confirmation via text message, please check "I agree to receive SMS updates from Real InvestCo".');
        }
        // Add contact type to form data
        formData.contactType = formData.propertyId ? 'property_inquiry' : 'general_inquiry';
        
        // Check if this contact already exists (for CA vs Web Up classification)
        let isCA = false;
        let existingContactId = null;
        let existingContactData = null;
        
        try {
          console.log('Checking for existing contact...');
          
          // Check by email first (if provided)
          if (formData.email) {
            console.log('Checking by email:', formData.email);
            console.log('Email lookup - exact match for:', formData.email);
            const emailQuery = await db.collection('contacts')
              .where('email', '==', formData.email)
              .limit(1)
              .get();
            console.log('Email query results:', emailQuery.empty ? 'No matches' : 'Found ' + emailQuery.docs.length + ' contact(s)');
            
            if (!emailQuery.empty) {
              isCA = true;
              existingContactId = emailQuery.docs[0].id;
              existingContactData = emailQuery.docs[0].data();
              console.log('Contact found by email (CA):', isCA, 'ID:', existingContactId);
              console.log('Found contact data:', existingContactData);
            }
          }
          
          // If not found by email, check by phone number (if provided)
          if (!isCA && formData.cellPhone) {
            console.log('Checking by phone:', formData.cellPhone);
            console.log('Phone lookup - exact match for:', formData.cellPhone);
            const phoneQuery = await db.collection('contacts')
              .where('cellPhone', '==', formData.cellPhone)
              .limit(1)
              .get();
            console.log('Phone query results:', phoneQuery.empty ? 'No matches' : 'Found ' + phoneQuery.docs.length + ' contact(s)');
            
            if (!phoneQuery.empty) {
              isCA = true;
              existingContactId = phoneQuery.docs[0].id;
              existingContactData = phoneQuery.docs[0].data();
              console.log('Contact found by phone (CA):', isCA, 'ID:', existingContactId);
              console.log('Found contact data:', existingContactData);
            }
          }
          
          // If not found by exact phone match, try different phone formats
          if (!isCA && formData.cellPhone) {
            console.log('Trying alternative phone formats...');
            const phoneVariations = [
              formData.cellPhone.replace(/\D/g, ''), // Remove all non-digits
              formData.cellPhone.replace(/\D/g, '').replace(/^1/, ''), // Remove leading 1
              formData.cellPhone.replace(/\D/g, '').replace(/^1/, '').replace(/(\d{3})(\d{3})(\d{4})/, '$1-$2-$3'), // Format as XXX-XXX-XXXX
              formData.cellPhone.replace(/\D/g, '').replace(/^1/, '').replace(/(\d{3})(\d{3})(\d{4})/, '($1) $2-$3'), // Format as (XXX) XXX-XXXX
            ];
            
            for (const phoneFormat of phoneVariations) {
              if (phoneFormat !== formData.cellPhone) {
                console.log('Trying phone format:', phoneFormat);
                const altPhoneQuery = await db.collection('contacts')
                  .where('cellPhone', '==', phoneFormat)
                  .limit(1)
                  .get();
                
                if (!altPhoneQuery.empty) {
                  isCA = true;
                  existingContactId = altPhoneQuery.docs[0].id;
                  existingContactData = altPhoneQuery.docs[0].data();
                  console.log('Contact found by alternative phone format:', phoneFormat, 'ID:', existingContactId);
                  console.log('Found contact data:', existingContactData);
                  break;
                }
              }
            }
          }

          // If not found by email or phone, check by name only (for admin-created contacts)
          if (!isCA && formData.name) {
            console.log('Checking by name only:', formData.name);
            console.log('Name lookup - exact match for:', formData.name);
            const nameQuery = await db.collection('contacts')
              .where('name', '==', formData.name)
              .limit(1)
              .get();
            console.log('Name query results:', nameQuery.empty ? 'No matches' : 'Found ' + nameQuery.docs.length + ' contact(s)');
            
            if (!nameQuery.empty) {
              isCA = true;
              existingContactId = nameQuery.docs[0].id;
              existingContactData = nameQuery.docs[0].data();
              console.log('Contact found by name (CA):', isCA, 'ID:', existingContactId);
              console.log('Found contact data:', existingContactData);
            }
          }

          // If not found by exact name match, try name variations
          if (!isCA && formData.name) {
            console.log('Trying name variations...');
            const nameVariations = [
              formData.name.trim(), // Remove extra spaces
              formData.name.trim().toLowerCase(), // Lowercase
              formData.name.trim().toUpperCase(), // Uppercase
              formData.name.trim().replace(/\s+/g, ' '), // Normalize spaces
            ];
            
            for (const nameFormat of nameVariations) {
              if (nameFormat !== formData.name) {
                console.log('Trying name format:', nameFormat);
                const altNameQuery = await db.collection('contacts')
                  .where('name', '==', nameFormat)
                  .limit(1)
                  .get();
                
                if (!altNameQuery.empty) {
                  isCA = true;
                  existingContactId = altNameQuery.docs[0].id;
                  existingContactData = altNameQuery.docs[0].data();
                  console.log('Contact found by name variation:', nameFormat, 'ID:', existingContactId);
                  console.log('Found contact data:', existingContactData);
                  break;
                }
              }
            }
          }

          // If not found by name, check by name + address combination
          if (!isCA && formData.name && formData.address_line1 && formData.address_city && formData.address_zip) {
            console.log('Checking by name + address:', formData.name, formData.address_line1, formData.address_city, formData.address_zip);
            const nameAddressQuery = await db.collection('contacts')
              .where('name', '==', formData.name)
              .where('address_line1', '==', formData.address_line1)
              .where('address_city', '==', formData.address_city)
              .where('address_zip', '==', formData.address_zip)
              .limit(1)
              .get();
            
            if (!nameAddressQuery.empty) {
              isCA = true;
              existingContactId = nameAddressQuery.docs[0].id;
              existingContactData = nameAddressQuery.docs[0].data();
              console.log('Contact found by name + address (CA):', isCA, 'ID:', existingContactId);
            }
          }
          
          // If still not found, check by phone number
          if (!isCA && (formData.cellPhone || formData.landline)) {
            const phone = formData.cellPhone || formData.landline;
            console.log('Checking by phone:', phone);
            const phoneQuery = await db.collection('contacts')
              .where('cellPhone', '==', phone)
              .limit(1)
              .get();
            
            if (!phoneQuery.empty) {
              isCA = true;
              existingContactId = phoneQuery.docs[0].id;
              existingContactData = phoneQuery.docs[0].data();
              console.log('Contact found by phone (CA):', isCA, 'ID:', existingContactId);
            }
          }
          
          console.log('Final CA status:', isCA, 'Existing ID:', existingContactId);
          console.log('Form data for lookup:', {
            email: formData.email,
            cellPhone: formData.cellPhone,
            landline: formData.landline,
            name: formData.name,
            address_line1: formData.address_line1,
            address_city: formData.address_city,
            address_zip: formData.address_zip
          });
        } catch (error) {
          console.error('Error checking existing contact:', error);
          // Default to Web Up if check fails
        }
        
        // Handle contact creation or update
        let contactId = existingContactId; // Use existing ID if found
        
        if (isCA && existingContactId) {
          // Update existing contact
          try {
            console.log('Updating existing CA contact:', existingContactId);
            
            // Prepare update data - merge new form data with existing data
            const updateData = {
              // Always update these fields from the form
              lastContactDate: firebase.firestore.FieldValue.serverTimestamp(),
              lastMessage: formData.message,
              lastContactType: formData.contactType,
              
              // Update email if provided and not already set
              email: formData.email || existingContactData.email,
              
              // Update phone if provided and not already set
              cellPhone: formData.cellPhone || formData.landline || existingContactData.cellPhone,
              
              // Update PPP data if completed in this form
              ...(formData.pppCompleted && formData.pppProfile ? {
                pppProfile: formData.pppProfile,
                pppCompleted: true,
                pppCompletedDate: firebase.firestore.FieldValue.serverTimestamp()
              } : {}),
              
              // Update interaction count
              interactionCount: (existingContactData.interactionCount || 0) + 1
            };
            
            // Update in Firebase
            console.log('Updating contact with data:', updateData);
            await db.collection('contacts').doc(existingContactId).update(updateData);
            console.log('‚úÖ Existing contact updated successfully in Firebase');
            
            // Add interaction record
            await addContactInteraction(existingContactId, formData);
            
            // Also update in Brevo if email is provided
            if (formData.email) {
              try {
                await fetch('https://us-central1-realinvestco-web.cloudfunctions.net/syncContactToBrevo', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({
                    email: formData.email,
                    name: formData.name,
                    phone: formData.cellPhone || formData.landline,
                    attributes: {
                      lastContactDate: new Date().toISOString(),
                      lastMessage: formData.message,
                      pppCompleted: formData.pppCompleted || existingContactData.pppCompleted || false
                    }
                  })
                });
                console.log('‚úÖ Contact updated in Brevo');
              } catch (brevoError) {
                console.error('Error updating contact in Brevo:', brevoError);
              }
            }
            
          } catch (updateError) {
            console.error('Error updating existing contact:', updateError);
            // Fall back to creating new contact if update fails
            isCA = false;
            existingContactId = null;
          }
        }
        
        if (!isCA || !existingContactId) {
          // Create new contact
          try {
            console.log('Creating new contact...');
          const brevoResponse = await fetch('https://us-central1-realinvestco-web.cloudfunctions.net/addContactToBrevo', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              name: formData.name,
              email: formData.email,
              phone: formData.cellPhone || formData.landline,
              message: formData.message,
              source: formData.source, // Use the actual source from form
              sendEmail: false, // Don't send email from this function
                isCA: false, // New contact
              pppProfile: formData.pppProfile // Pass PPP data
            })
          });

          if (brevoResponse.ok) {
            const result = await brevoResponse.json();
            contactId = result.contactId;
              console.log('‚úÖ New contact created successfully, ID:', contactId);
          } else {
            const errorText = await brevoResponse.text();
            console.error('Failed to add contact to Brevo:', brevoResponse.status, errorText);
          }
        } catch (brevoError) {
          console.error('Error adding contact to Brevo:', brevoError);
          // Don't fail the form submission if Brevo fails
          }
        }

        // Send confirmation email using Brevo template
        try {
          // Determine which template to use based on PPP completion and source
          let templateId;
          let contactType = 'Web Up'; // Default to Web Up for direct website visits
          
          if (isCA) {
            contactType = 'CA';
            // CA contacts: Template 10 (with PPP) or 11 (without PPP)
            templateId = formData.pppCompleted ? 10 : 11;
          } else {
            // Web Up contacts: Template 8 (with PPP) or 9 (without PPP)
            templateId = formData.pppCompleted ? 8 : 9;
          }
          
          console.log(`Contact type: ${contactType}, PPP completed: ${formData.pppCompleted}, Template: ${templateId}`);
          
          const response = await fetch('https://us-central1-realinvestco-web.cloudfunctions.net/sendBrevoTemplateEmail', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              toEmail: formData.email,
              toName: formData.name,
              templateId: templateId,
              subject: 'Thank you for your inquiry - Real InvestCo',
              templateVariables: {
                NAME: formData.name,
                MESSAGE: formData.message,
                PROPERTY_TITLE: formData.propertyTitle || '',
                PHONE: formData.cellPhone || formData.landline || '',
                CONTACT_TYPE: contactType,
                PPP_COMPLETED: formData.pppCompleted ? 'Yes' : 'No',
                PPP_LINK: formData.pppCompleted ? '' : 'https://realinvestco.vercel.app/ppp.html'
              }
            })
          });

          if (!response.ok) {
            console.error('Failed to send confirmation email via Brevo template');
          } else {
            console.log('Confirmation email sent successfully using Brevo template', templateId);
          }
        } catch (emailError) {
          console.error('Error sending confirmation email:', emailError);
          // Don't fail the form submission if email fails
        }

        // Send confirmation SMS if phone number is provided and SMS opt-in is checked
        if ((formData.cellPhone || formData.landline) && formData.smsOptIn) {
          try {
            console.log('Sending confirmation SMS...');
            
            // Determine SMS template type based on contact type and PPP completion
            let smsType;
            if (isCA) {
              smsType = formData.pppCompleted ? 'ca_with_ppp' : 'ca_without_ppp';
            } else {
              smsType = formData.pppCompleted ? 'web_with_ppp' : 'web_without_ppp';
            }
            
            console.log(`SMS type: ${smsType}, Phone: ${formData.cellPhone || formData.landline}`);
            
            const smsResponse = await fetch('https://us-central1-realinvestco-web.cloudfunctions.net/sendSmsWebhook', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                smsType: smsType,
                contactData: {
                  contactId: contactId,
                  name: formData.name,
                  phone: formData.cellPhone || formData.landline,
                  email: formData.email,
                  propertyId: formData.propertyId || null,
                  propertyTitle: formData.propertyTitle || null
                }
              })
            });

            if (!smsResponse.ok) {
              const errorText = await smsResponse.text();
              console.error('Failed to send confirmation SMS:', smsResponse.status, errorText);
            } else {
              console.log('Confirmation SMS sent successfully');
            }
          } catch (smsError) {
            console.error('Error sending confirmation SMS:', smsError);
            // Don't fail the form submission if SMS fails
          }
        } else if (formData.cellPhone || formData.landline) {
          console.log('Phone number provided but SMS opt-in not checked - no SMS sent');
        }

        // Show success message
        formContainer.style.display = 'none';
        formSuccess.style.display = 'block';
        if (window._propertyTitle) {
          const successTitle = document.getElementById('success-property-title');
          successTitle.textContent = `You inquired about: ${window._propertyTitle}`;
          successTitle.style.display = 'block';
        } else {
          const successTitle = document.getElementById('success-property-title');
          successTitle.style.display = 'none';
        }
      } catch (error) {
        alert(error.message || 'There was an error submitting your message. Please try again.');
      } finally {
        submitButton.disabled = false;
        submitButton.textContent = 'Send Message';
      }
    });

    continueBtn.addEventListener('click', () => {
      formSuccess.style.display = 'none';
      formContainer.style.display = 'block';
      contactForm.reset();
      // Redirect to property page if propertyId is present, else to properties page
      const propId = new URLSearchParams(window.location.search).get('propertyId');
      if (propId) {
        window.location.href = `property.html?id=${encodeURIComponent(propId)}`;
      } else {
        window.location.href = 'properties.html';
      }
    });

    // Function to add interaction record
    async function addContactInteraction(contactId, formData) {
      try {
        const interactionData = {
          contactId: contactId,
          contactEmail: formData.email,
          contactName: formData.name,
          type: 'form_submission',
          notes: `Contact form submitted: ${formData.message.substring(0, 100)}${formData.message.length > 100 ? '...' : ''}`,
          source: formData.source,
          propertyTitle: formData.propertyTitle || null,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        };

        await db.collection('contactInteractions').add(interactionData);
        console.log('‚úÖ Interaction record added successfully');
      } catch (error) {
        console.error('Error adding interaction record:', error);
        // Don't fail the form submission if interaction logging fails
      }
    }

  </script>
</body>
</html> 